<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendizaje del Alfabeto ASL</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/duolingo-theme.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #E5E5E5 0%, #F7F7F7 100%);
            color: var(--duo-gray-900);
            min-height: 100vh;
        }

        /* Header estilo Duolingo */
        .header-duo {
            background: var(--duo-white);
            border-bottom: 2px solid var(--duo-gray-100);
            padding: var(--space-4) 0;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-6);
        }

        .header-logo {
            font-size: var(--text-2xl);
            font-weight: var(--font-extrabold);
            color: var(--duo-green);
        }

        .header-nav {
            display: flex;
            gap: var(--space-4);
            flex: 1;
        }

        .nav-link {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            text-decoration: none;
            color: var(--duo-gray-700);
            font-weight: var(--font-semibold);
            transition: all var(--transition-fast);
        }

        .nav-link:hover {
            background: var(--duo-gray-50);
            color: var(--duo-blue);
        }

        .nav-link.active {
            background: var(--duo-blue);
            color: var(--duo-white);
        }

        /* Estadísticas en header */
        .header-stats {
            display: flex;
            gap: var(--space-4);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-2) var(--space-4);
            background: var(--duo-gray-50);
            border-radius: var(--radius-lg);
            min-width: 70px;
        }

        .stat-value {
            font-size: var(--text-xl);
            font-weight: var(--font-extrabold);
            color: var(--duo-gray-900);
        }

        .stat-label {
            font-size: var(--text-xs);
            color: var(--duo-gray-500);
            font-weight: var(--font-semibold);
        }

        .stat-item.stat-streak .stat-value {
            color: var(--duo-yellow);
        }

        .stat-item.stat-points .stat-value {
            color: var(--duo-green);
        }

        .stat-item.stat-level .stat-value {
            color: var(--duo-blue);
        }

        /* Contenedor principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-6);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* Sección de video */
        .video-section {
            background: var(--duo-white);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            border: 3px solid var(--duo-gray-100);
            transition: all var(--transition-base);
        }

        .video-section.detecting {
            border-color: var(--duo-blue);
            box-shadow: var(--shadow-blue);
        }

        .video-section.success {
            border-color: var(--duo-green);
            box-shadow: var(--shadow-green);
        }

        .section-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-extrabold);
            color: var(--duo-gray-900);
            margin-bottom: var(--space-4);
        }

        #videoElement {
            width: 100%;
            height: 400px;
            border-radius: var(--radius-xl);
            background: var(--duo-gray-100);
            object-fit: cover;
            position: relative;
        }

        .video-wrapper {
            position: relative;
            margin-bottom: var(--space-4);
        }

        /* Mensaje de feedback sobre el video */
        .feedback-message {
            position: absolute;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-full);
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }

        .feedback-message.idle {
            color: var(--duo-gray-600);
        }

        .feedback-message.adjusting {
            color: var(--duo-yellow-dark);
        }

        .feedback-message.almost {
            color: var(--duo-blue);
        }

        .feedback-message.perfect {
            color: var(--duo-green);
        }

        /* Barra de confianza */
        .confidence-bar-container {
            margin-bottom: var(--space-4);
        }

        .confidence-bar {
            width: 100%;
            height: 12px;
            background: var(--duo-gray-100);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            transition: all var(--transition-base);
            border-radius: var(--radius-full);
        }

        .confidence-fill.low {
            background: var(--duo-red);
        }

        .confidence-fill.medium {
            background: var(--duo-yellow);
        }

        .confidence-fill.high {
            background: var(--duo-green);
        }

        .confidence-label {
            font-size: var(--text-sm);
            color: var(--duo-gray-600);
            font-weight: var(--font-semibold);
            margin-top: var(--space-2);
            text-align: center;
        }

        /* Controles */
        .controls {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
        }

        /* Sección de resultados */
        .results-section {
            background: var(--duo-white);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            border: 3px solid var(--duo-gray-100);
        }

        .detection-result {
            text-align: center;
            padding: var(--space-6);
            background: var(--duo-gray-50);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
        }

        .detected-letter {
            font-size: 6rem;
            font-weight: var(--font-extrabold);
            margin-bottom: var(--space-2);
            color: var(--duo-gray-400);
            transition: all var(--transition-base);
        }

        .detected-letter.success {
            color: var(--duo-green);
        }

        .confidence-info {
            font-size: var(--text-lg);
            color: var(--duo-gray-600);
            font-weight: var(--font-semibold);
        }

        /* Grid de alfabeto */
        .alphabet-progress {
            margin-top: var(--space-6);
        }

        .alphabet-progress h3 {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--duo-gray-900);
            margin-bottom: var(--space-4);
        }

        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: var(--space-2);
        }

        .letter-box {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-weight: var(--font-extrabold);
            font-size: var(--text-2xl);
            cursor: pointer;
            transition: all var(--transition-base);
            background: var(--duo-gray-100);
            color: var(--duo-gray-400);
            border: 2px solid transparent;
        }

        .letter-box.detected {
            background: var(--duo-green);
            color: var(--duo-white);
            transform: scale(1.05);
            box-shadow: var(--shadow-green);
        }

        .letter-box.current {
            background: var(--duo-blue);
            color: var(--duo-white);
            border-color: var(--duo-blue-dark);
            animation: pulse 2s infinite;
        }

        .letter-box:hover:not(.detected) {
            transform: scale(1.05);
            background: var(--duo-gray-200);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-container {
                flex-wrap: wrap;
            }
            
            .header-nav {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .header-stats {
                gap: var(--space-2);
            }
            
            .stat-item {
                min-width: 60px;
                padding: var(--space-1) var(--space-2);
            }
        }
    </style>
</head>
<body>
    <!-- Header estilo Duolingo -->
    <header class="header-duo">
        <div class="header-container">
            <div class="header-logo">ASL Learning</div>
            <nav class="header-nav">
                <a href="/" class="nav-link active">Inicio</a>
                <a href="/practice" class="nav-link">Práctica</a>
                <a href="/games" class="nav-link">Juegos</a>
                <a href="/guide" class="nav-link">Guía</a>
            </nav>
            <div class="header-stats">
                <div class="stat-item stat-streak">
                    <span class="stat-value" id="streak-value">0</span>
                    <span class="stat-label">Racha</span>
                </div>
                <div class="stat-item stat-points">
                    <span class="stat-value" id="points-value">0</span>
                    <span class="stat-label">Puntos</span>
                </div>
                <div class="stat-item stat-level">
                    <span class="stat-value" id="level-value">1</span>
                    <span class="stat-label">Nivel</span>
                </div>
            </div>
        </div>
    </header>

    {% if is_guest %}
    <div style="background: rgba(28, 176, 246, 0.1); border: 2px solid var(--duo-blue); color: var(--duo-blue-dark); padding: var(--space-3); text-align:center;">
        Modo invitado activo — funcionalidad en fase beta
        <form action="/auth/logout" method="post" style="display:inline; margin-left: var(--space-3);">
            <button class="btn-duo btn-outline btn-sm" type="submit">Cerrar invitado</button>
        </form>
    </div>
    {% endif %}
    <div class="container">
        <main class="main-content">
            <!-- Área de Video -->
            <section class="video-section" id="videoSection">
                <h2 class="section-title">Cámara de Reconocimiento</h2>
                
                <div class="video-wrapper">
                    <video id="videoElement" autoplay muted></video>
                    <div class="feedback-message idle" id="feedbackMessage">
                        Muestra una letra
                    </div>
                </div>

                <!-- Barra de confianza -->
                <div class="confidence-bar-container">
                    <div class="confidence-bar">
                        <div class="confidence-fill low" id="confidenceFill" style="width: 0%"></div>
                    </div>
                    <div class="confidence-label" id="confidenceLabel">Confianza: 0%</div>
                </div>
                
                <div class="controls">
                    <button id="startBtn" class="btn-duo btn-primary">Iniciar Cámara</button>
                    <button id="stopBtn" class="btn-duo btn-danger" disabled>Detener</button>
                    <button class="btn-duo btn-secondary" onclick="window.location.href='/practice'">Modo Práctica</button>
                </div>
            </section>

            <!-- Panel de Resultados -->
            <section class="results-section">
                <h2 class="section-title">Reconocimiento en Tiempo Real</h2>
                
                <div class="detection-result">
                    <div class="detected-letter" id="detectedLetter">-</div>
                    <div class="confidence-info" id="confidenceInfo">Esperando detección...</div>
                </div>

                <!-- Progreso del Alfabeto -->
                <div class="alphabet-progress">
                    <h3>Letras Reconocidas</h3>
                    <div class="alphabet-grid" id="alphabetGrid">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="/static/js/games/storage-manager.js"></script>
    <script src="/static/js/games/points-system.js"></script>
    <script src="/static/js/games/achievements.js"></script>
    <script src="/static/js/games/ui-effects.js"></script>
    
    <script>
        // Variables globales
        let video, isDetecting = false;
        let detectedLetters = new Set();
        let currentDetection = null;
        let storageManager = new StorageManager();

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeAlphabet();
            setupEventListeners();
            loadUserStats();
        });

        function loadUserStats() {
            const progress = storageManager.loadProgress();
            document.getElementById('streak-value').textContent = progress.streak || 0;
            document.getElementById('points-value').textContent = progress.points || 0;
            document.getElementById('level-value').textContent = progress.level || 1;
            
            // Cargar letras completadas
            if (progress.lettersCompleted && progress.lettersCompleted.length > 0) {
                progress.lettersCompleted.forEach(letter => {
                    detectedLetters.add(letter);
                    const letterBox = document.getElementById(`letter-${letter}`);
                    if (letterBox) {
                        letterBox.classList.add('detected');
                    }
                });
            }
        }

        function initializeAlphabet() {
            const alphabetGrid = document.getElementById('alphabetGrid');
            const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y'];
            
            alphabetGrid.innerHTML = '';
            letters.forEach(letter => {
                const letterBox = document.createElement('div');
                letterBox.className = 'letter-box';
                letterBox.textContent = letter;
                letterBox.id = `letter-${letter}`;
                alphabetGrid.appendChild(letterBox);
            });
        }

        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startDetection);
            document.getElementById('stopBtn').addEventListener('click', stopDetection);
        }

        async function startDetection() {
            try {
                video = document.getElementById('videoElement');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('videoSection').classList.add('detecting');
                
                isDetecting = true;
                detectLoop();
                
                UIEffects.showToast('Cámara iniciada correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                UIEffects.showToast('Error al acceder a la cámara', 'error');
            }
        }

        function stopDetection() {
            isDetecting = false;
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('videoSection').classList.remove('detecting', 'success');
            
            updateFeedbackMessage(0, null);
            UIEffects.showToast('Detección detenida', 'info');
        }

        async function detectLoop() {
            if (!isDetecting) return;

            try {
                if (!video || video.videoWidth === 0) {
                    setTimeout(detectLoop, 500);
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                const response = await fetch('/detect_gesture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (response.ok) {
                    const result = await response.json();
                    updateResults(result);
                }
                
            } catch (error) {
                console.error('Error en detección:', error);
            }

            if (isDetecting) {
                setTimeout(detectLoop, 300);
            }
        }

        function updateResults(result) {
            const detectedLetterEl = document.getElementById('detectedLetter');
            const confidenceEl = document.getElementById('confidenceInfo');
            
            if (result.success && result.letter) {
                const confidence = result.confidence * 100;
                
                detectedLetterEl.textContent = result.letter;
                detectedLetterEl.className = 'detected-letter success';
                confidenceEl.textContent = `Confianza: ${Math.round(confidence)}%`;
                
                // Actualizar barra de confianza
                updateConfidenceBar(confidence);
                
                // Actualizar mensaje de feedback
                updateFeedbackMessage(confidence, result.letter);
                
                // Marcar letra como detectada si confianza > 70%
                if (confidence > 70) {
                    const wasNew = !detectedLetters.has(result.letter);
                    detectedLetters.add(result.letter);
                    
                    const letterBox = document.getElementById(`letter-${result.letter}`);
                    if (letterBox && !letterBox.classList.contains('detected')) {
                        letterBox.classList.add('detected');
                        
                        if (wasNew) {
                            // Guardar progreso
                            storageManager.addCompletedLetter(result.letter);
                            
                            // Mostrar confetti
                            UIEffects.showConfetti();
                            
                            // Animar puntos
                            const pointsEl = document.getElementById('points-value');
                            UIEffects.animatePoints(pointsEl, 10, 'normal');
                        }
                    }
                    
                    document.getElementById('videoSection').classList.add('success');
                } else {
                    document.getElementById('videoSection').classList.remove('success');
                }
                
            } else {
                detectedLetterEl.textContent = '-';
                detectedLetterEl.className = 'detected-letter';
                confidenceEl.textContent = result.message || 'Sin detección';
                updateConfidenceBar(0);
                updateFeedbackMessage(0, null);
                document.getElementById('videoSection').classList.remove('success');
            }
        }

        function updateConfidenceBar(confidence) {
            const fill = document.getElementById('confidenceFill');
            const label = document.getElementById('confidenceLabel');
            
            fill.style.width = `${confidence}%`;
            label.textContent = `Confianza: ${Math.round(confidence)}%`;
            
            // Cambiar color según nivel de confianza
            fill.className = 'confidence-fill';
            if (confidence > 70) {
                fill.classList.add('high');
            } else if (confidence > 50) {
                fill.classList.add('medium');
            } else {
                fill.classList.add('low');
            }
        }

        function updateFeedbackMessage(confidence, letter) {
            const message = document.getElementById('feedbackMessage');
            
            message.className = 'feedback-message';
            
            if (confidence === 0) {
                message.textContent = 'Muestra una letra';
                message.classList.add('idle');
            } else if (confidence < 50) {
                message.textContent = 'Ajusta posición';
                message.classList.add('adjusting');
            } else if (confidence < 70) {
                message.textContent = 'Casi... mantén la posición';
                message.classList.add('almost');
            } else {
                message.textContent = 'Perfecto';
                message.classList.add('perfect');
            }
        }
    </script>
</body>
</html>
